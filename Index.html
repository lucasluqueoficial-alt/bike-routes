<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Função Bike - Rotas de Bicicleta</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  html, body { height: 100%; margin:0; padding:0; font-family: Arial, sans-serif; }
  #map { height: 80%; width: 100%; }
  .controls { padding:10px; background: #222; color:#fff; display:flex; flex-wrap:wrap; gap:5px; align-items:center; }
  input, button { padding:5px; font-size:14px; border-radius:5px; border:none; }
  button { background:#f55005; color:#fff; cursor:pointer; }
</style>
</head>
<body>

<div class="controls">
  <input id="start" type="text" placeholder="Digite o ponto de partida" style="flex:1">
  <input id="end" type="text" placeholder="Digite o destino" style="flex:1">
  <button onclick="getRoute()">Traçar Rota</button>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([-21.1699, -47.8103], 13); // Ribeirão Preto

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let routeLayer = null;
let userMarker = null;

// Função para mostrar a posição atual
function locateUser(){
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      if(!userMarker){
        userMarker = L.marker([lat,lng]).addTo(map).bindPopup("Você está aqui").openPopup();
      } else {
        userMarker.setLatLng([lat,lng]);
      }
      map.setView([lat,lng], 14);
    });
  }
}
setInterval(locateUser, 3000); // Atualiza a cada 3s

async function getRoute(){
  const start = document.getElementById('start').value;
  const end = document.getElementById('end').value;

  if(!start || !end){
    alert("Preencha ambos os campos");
    return;
  }

  // Geocodificar os endereços via OpenRouteService API
  const apiKey = "COLOQUE_SUA_CHAVE_ORS_AQUI"; // substitua pela sua chave ORS
  async function geocode(address){
    const resp = await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${apiKey}&text=${encodeURIComponent(address)}`);
    const data = await resp.json();
    if(data.features.length>0){
      return data.features[0].geometry.coordinates.reverse(); // retorna [lat,lng]
    }
    return null;
  }

  const startCoord = await geocode(start);
  const endCoord = await geocode(end);

  if(!startCoord || !endCoord){
    alert("Não foi possível localizar os endereços");
    return;
  }

  // Traçar rota de bicicleta
  const resp = await fetch(`https://api.openrouteservice.org/v2/directions/cycling-regular?api_key=${apiKey}&start=${startCoord[1]},${startCoord[0]}&end=${endCoord[1]},${endCoord[0]}`);
  const data = await resp.json();
  const coords = data.features[0].geometry.coordinates.map(c => [c[1], c[0]]);

  if(routeLayer) map.removeLayer(routeLayer);
  routeLayer = L.polyline(coords, {color:'blue', weight:5}).addTo(map);
  map.fitBounds(routeLayer.getBounds());
}
</script>
</body>
</html>
